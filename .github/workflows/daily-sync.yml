name: Data Sync to My HF

on:
  schedule:
    - cron: '0 0 * * *' # Runs daily at midnight UTC
  workflow_dispatch:      # Allow manual trigger

permissions:
  contents: write  # Grant write permission to commit and push changes

jobs:
  sync-job:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          lfs: true # Enable LFS support
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Global Config
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git lfs install

      - name: Sync Data
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          # 1. Clone the upstream repository to a temporary directory
          git clone https://huggingface.co/datasets/bwzheng2010/yahoo-finance-data /tmp/upstream-repo

          # 2. Copy all files from upstream to current directory, excluding .git
          rsync -av --delete /tmp/upstream-repo/ ./ \
            --exclude='.git/' \
            --exclude='.github/' \
            --exclude='README.md' \
            --exclude='task.md' \
            --exclude='*.py' \
            --exclude='*.sh' \
            --exclude='requirements.txt'

          # 3. Remove the temporary directory
          rm -rf /tmp/upstream-repo

          # 4. Check if there are changes to commit
          if [[ -n $(git status --porcelain) ]]; then
            git add .
            git commit -m "Auto-sync from upstream [skip ci]"

            # 5. Push updates to the current repository (GitHub)
            git push origin main
          else
            echo "No changes to commit"
          fi