name: Data Sync to My HF

on:
  schedule:
    - cron: '0 0 * * *' # 每天运行
  workflow_dispatch:      # 允许你点击按钮手动运行

jobs:
  sync-job:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          lfs: true # 开启 LFS 支持
          fetch-depth: 0

      - name: Global Config
        run: |
          git config --global user.name 'winterandchaiyun'
          git config --global user.email 'alex.zhou@example.com'
          git lfs install

      - name: Sync Data
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          # 1. 添加原作者地址 (Upstream)
          git remote add upstream https://huggingface.co/datasets/bwzheng2010/yahoo-finance-data

          # 2. 添加你自己的地址 (Target) - only if HF_TOKEN is provided
          if [ -n "$HF_TOKEN" ]; then
            git remote add target https://winterandchaiyun:$HF_TOKEN@huggingface.co/datasets/winterandchaiyun/yahoo-finance-data
          fi

          # 3. 拉取原作者最新的数据到 GitHub 临时空间
          git fetch upstream main

          # 4. 合并数据，如果有冲突以原作者的为准 (-X theirs)
          git merge upstream/main -m "Auto-sync from bwzheng2010 [skip ci]" -X theirs --allow-unrelated-histories

          # 5. 推送更新到 GitHub
          git push origin main

          # 6. 如果提供了 HF_TOKEN，则尝试推送到 Hugging Face
          if [ -n "$HF_TOKEN" ]; then
            echo "Attempting to push to Hugging Face..."
            git push target main --force || echo "Failed to push to Hugging Face (may not exist yet)"
          else
            echo "HF_TOKEN not provided, skipping Hugging Face push"
          fi