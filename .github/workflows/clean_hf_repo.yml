name: Clean HF Repository

on:
  workflow_dispatch:  # 只允许手动触发

jobs:
  clean-job:
    runs-on: ubuntu-latest
    steps:
      - name: Global Config
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git lfs install

      - name: Clean HF Repository
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          set -e
          
          if [ -z "$HF_TOKEN" ]; then
            echo "错误: HF_TOKEN 未设置"
            exit 1
          fi
          
          # 创建临时目录
          TEMP_DIR=$(mktemp -d)
          echo "使用临时目录: $TEMP_DIR"
          
          # 克隆目标仓库
          echo "克隆目标仓库..."
          cd "$TEMP_DIR"
          git clone https://winterandchaiyun:$HF_TOKEN@huggingface.co/datasets/winterandchaiyun/yahoo-finance-data repo
          cd repo
          git lfs install
          git lfs pull || echo "LFS pull 警告，继续..."
          
          # 配置 git
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          
          # 删除所有非数据文件
          echo "清理文件..."
          # 保留的文件列表
          KEEP_FILES=(
            "*.parquet"
            "README.md"
            ".gitattributes"
            "spec.json"
            "dataset_infos.json"
            "dataset_info.json"
          )
          
          # 删除所有文件（除了 .git 和要保留的文件）
          find . -mindepth 1 -maxdepth 1 ! -name '.git' ! -name '.gitattributes' ! -name 'README.md' ! -name 'spec.json' ! -name 'dataset_infos.json' ! -name 'dataset_info.json' ! -name '*.parquet' -exec rm -rf {} \;
          
          # 删除子目录中的非数据文件
          find . -type f ! -name '*.parquet' ! -name 'README.md' ! -name '.gitattributes' ! -name 'spec.json' ! -name 'dataset_infos.json' ! -name 'dataset_info.json' ! -path './.git/*' -delete
          
          # 删除空目录（除了 .git）
          find . -mindepth 1 -type d ! -path './.git*' -empty -delete
          
          # 检查是否有更改
          git add -A
          if ! git diff --staged --quiet || ! git diff --quiet; then
            echo "提交清理更改..."
            git commit -m "Clean up: remove code and config files, keep only data files" || echo "没有更改需要提交"
            
            echo "推送到 Hugging Face..."
            git lfs push origin main --all || echo "LFS push 警告，继续..."
            git push origin main --force
            echo "✓ 清理完成！"
          else
            echo "仓库已经干净，无需更改"
          fi
          
          # 清理
          cd /
          rm -rf "$TEMP_DIR"
