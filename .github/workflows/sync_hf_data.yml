name: Data Sync to My HF

on:
  schedule:
    - cron: '0 0 * * *' # 每天 UTC 时间 0:00 运行（北京时间早上 8:00）
  workflow_dispatch:      # 允许你点击按钮手动运行

jobs:
  sync-job:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          lfs: true # 开启 LFS 支持
          fetch-depth: 0

      - name: Global Config
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git lfs install

      - name: Sync Data
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          set -e
          
          if [ -z "$HF_TOKEN" ]; then
            echo "错误: HF_TOKEN 未设置，请到 GitHub Secrets 中设置"
            exit 1
          fi
          
          # 创建临时目录用于同步数据
          TEMP_DIR=$(mktemp -d)
          echo "使用临时目录: $TEMP_DIR"
          
          # 1. 克隆 upstream 数据集到临时目录
          echo "从 upstream 克隆数据集..."
          git clone --depth 1 https://huggingface.co/datasets/bwzheng2010/yahoo-finance-data "$TEMP_DIR/upstream"
          cd "$TEMP_DIR/upstream"
          git lfs install
          git lfs pull
          
          # 2. 初始化目标仓库（如果不存在则创建）
          cd "$TEMP_DIR"
          git init target-repo
          cd target-repo
          git lfs install
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          
          # 3. 先复制 .gitattributes（必须在复制文件之前设置 LFS 规则）
          echo "设置 Git LFS 配置..."
          if [ -f ../upstream/.gitattributes ]; then
            cp ../upstream/.gitattributes .
            git add .gitattributes
            git commit -m "Add .gitattributes for LFS" || true
          else
            # 如果没有 .gitattributes，创建一个基本的
            echo "*.parquet filter=lfs diff=lfs merge=lfs -text" > .gitattributes
            git add .gitattributes
            git commit -m "Add .gitattributes for LFS" || true
          fi
          
          # 4. 添加 target remote
          git remote add target https://winterandchaiyun:$HF_TOKEN@huggingface.co/datasets/winterandchaiyun/yahoo-finance-data
          
          # 5. 尝试拉取现有内容（如果仓库已存在）
          git fetch target main || echo "目标仓库为空或不存在，将创建新仓库"
          git checkout -b main || git checkout main || true
          
          # 6. 清理现有文件（只保留数据文件）
          echo "清理现有文件..."
          # 删除所有文件（除了 .git）
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} \;
          
          # 7. 只复制数据文件（不包含代码、workflow 等）
          echo "复制数据文件..."
          # 复制所有 .parquet 文件（LFS 会自动处理）
          find ../upstream -name "*.parquet" -exec cp {} . \;
          # 复制 README.md（如果存在）
          [ -f ../upstream/README.md ] && cp ../upstream/README.md . || true
          # 复制 spec.json（如果存在）
          [ -f ../upstream/spec.json ] && cp ../upstream/spec.json . || true
          # 复制 dataset_infos.json（如果存在）
          [ -f ../upstream/dataset_infos.json ] && cp ../upstream/dataset_infos.json . || true
          [ -f ../upstream/dataset_info.json ] && cp ../upstream/dataset_info.json . || true
          
          # 8. 添加并提交数据文件
          git add -A
          if ! git diff --staged --quiet; then
            git commit -m "Auto-sync data from bwzheng2010/yahoo-finance-data [skip ci]"
            echo "推送到 Hugging Face..."
            git lfs push target main --all
            git push target main --force
            echo "✓ 数据同步完成！"
          else
            echo "没有新数据需要同步"
          fi
          
          # 清理临时目录
          cd /
          rm -rf "$TEMP_DIR"
